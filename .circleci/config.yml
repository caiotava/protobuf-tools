version: 2
jobs:
  build:
    docker:
      - image: buildpack-deps

    steps:
      - checkout

      - setup_remote_docker

      - run: make docker-build

  push:
    docker:
      - image: buildpack-deps

    steps:
      - checkout

      - setup_remote_docker

      - run:
        name: docker hub login
        command: docker login -u $DOCKER_USER -o $DOCKER_PASSWORD

      - run:
        name: build and push image
        command: make docker-push

workflows:
  version: 2
  continuous_deploy:
    jobs:
      - build
      - push:
          requires:
            - build
          filters:
            tags:
              only: /^v[0-9]+\.[0-9]+\.[0-9]{1,3}(-(alpha|beta|rc)?(\.[0-9])?)?$/
            branches:
              ignore: /.*/

